# Cloudflare Pages 部署配置指南

## 问题诊断

您遇到的 404 错误主要是因为直接上传了 `.next` 目录，但缺少必要的路由配置。

## 立即修复步骤

### 步骤 1: 在 Cloudflare Pages 控制台配置构建设置

访问: `https://dash.cloudflare.com` → Pages → `blog-web` → Settings → Builds & deployments

配置以下内容:

**构建配置:**
- **Framework preset**: `Next.js`
- **Build command**: `npm run pages:build`
- **Build output directory**: `.vercel/output/static`
- **Root directory**: `/`  (留空或填 `/`)
- **Node版本**: `18` 或更高

### 步骤 2: 配置环境变量 (可选,如果需要API功能)

在 Settings → Environment variables 添加:

```
AUTH_SECRET=<运行 openssl rand -hex 32 生成>
DATABASE_ID=e90bacef-2fd5-4f4c-874c-aeeae04e1f9a
```

### 步骤 3: 配置数据库和 KV 绑定

在 Settings → Functions → Bindings 添加:

**D1 数据库:**
- Variable name: `DB`
- D1 database: 选择 `blog-database`

**KV 命名空间:**
- Variable name: `KV_SESSIONS`
- KV namespace: 选择对应的 KV (ID: 370ad8b37672482ebd31f532726d7964)

### 步骤 4: 重新部署

有两种方式:

**方式 A: 通过 Git 自动部署 (推荐)**
1. 提交并推送代码到 GitHub
   ```powershell
   git add .
   git commit -m "Fix Cloudflare Pages routing configuration"
   git push origin master
   ```
2. Cloudflare Pages 会自动触发构建和部署

**方式 B: 本地构建手动部署**
1. 本地构建:
   ```powershell
   npm run pages:build
   ```
2. 使用 Wrangler 部署:
   ```powershell
   npx wrangler pages deploy .vercel/output/static --project-name=blog-web
   ```

## 已修复的问题

1. ✅ 创建了 `_routes.json` 配置文件 - 告诉 Cloudflare 如何处理路由
2. ✅ 更新了 `next.config.js` - 添加 Cloudflare Pages 优化配置

## 验证部署

部署成功后，访问以下 URL:
- 主域名: `https://aincfh.dpdns.org`
- Pages 域名: `https://blog-web-48w.pages.dev`
- 最新部署: `https://master.blog-web-48w.pages.dev`

## 常见问题

### Q: 构建失败，提示找不到命令
**A**: 确保在 Cloudflare Pages 设置中正确配置了构建命令 `npm run pages:build`

### Q: 仍然显示 404
**A**: 
1. 检查构建日志，确认构建成功
2. 确认 `_routes.json` 文件在 `public` 目录下
3. 清除浏览器缓存后重试
4. 等待几分钟让 CDN 缓存刷新

### Q: API 路由不工作
**A**: 确保在 Cloudflare Pages 设置中正确绑定了 D1 数据库和 KV

## 下一步

部署成功后，您可以:
1. 在 Cloudflare Dashboard 查看访问统计
2. 配置缓存规则优化性能
3. 设置通知接收部署状态更新
